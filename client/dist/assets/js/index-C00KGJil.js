import{h as _,q as J}from"./index-DqO_OEbo.js";import{L as Q,X,Y,N as x,Z as z,$ as K,b as S}from"./ui-vendor-D13i6_Ys.js";import{A as W}from"./ArchiveOutline-r281DOBm.js";import{k as B,r as Z,Z as U,X as v,_ as h,U as g,a3 as D,Y as G,Q as w,j as P}from"./vue-vendor-Zc8KthId.js";import"./utils-vendor-lGwZSMVs.js";function A(n,o){const l=[],m=n.size;let r=0;for(;r<m;){const d=n.slice(r,r+o);l.push(d),r+=o}return l}const F=async function(n,o=1){if(!Array.isArray(n))throw new TypeError("First argument must be an array of functions");if(o<1)throw new RangeError("Concurrency limit must be at least 1");let l=0;const m=[],r=Array(Math.min(o,n.length)).fill(null).map(async()=>{for(;l<n.length;){const d=l++;try{m[d]=await n[d]()}catch(f){throw f instanceof Error?f:new Error(String(f))}}});return await Promise.all(r),m},N=async()=>_.get("/api/upload/getUploadId");async function H(n,o){return _.post("/api/upload/file",n,o)}async function L(n){return _.get(`/api/upload/chunk/check?${J.stringify(n)}`)}async function R(n,o){return _.post("/api/upload/chunk",n,o)}async function T(n){return _.post("/api/upload/chunk/merge",n)}async function j(n){return _.get("/api/upload/progress",n)}const E={class:"mt-12px"},tn=B({__name:"index",setup(n){const o=Z(0),l=Z(0);async function m(s){const{data:{uploadId:t}}=await N(),e=new FormData;e.set("file",s),e.set("uploadId",t),e.set("name",s.name),H(e,{isUpload:!0,onUploadProgress:a=>{l.value=Math.ceil(a.loaded/a.total*100)}})}async function r(s){const{hash:t,file:e,chunks:a}=s,{data:u}=await L({hash:t,filename:e.name,chunkTotal:a.length}),i=[],{data:{uploadId:p}}=await N();a.forEach((C,b)=>{if(!u[b]){const V=()=>{const y=new FormData;return y.set("file",C),y.set("uploadId",p),y.set("hash",t),y.set("index",b.toString()),R(y,{isUpload:!0,onUploadProgress:I=>{console.log(`chunk(${b})上传进度:`,`${Math.ceil(I.loaded/I.total*100)}%`)}})};i.push(V)}});const c=setInterval(async()=>{const{data:{progress:C}}=await j({hash:t,totalSize:e.size});if(o.value=C,C>=100){clearInterval(c),$message.success("上传成功");return}},300);await F(i,3),await T({name:e.name,hash:t})}function d(s){return new Promise((t,e)=>{const a=new URL("data:video/mp2t;base64,aW1wb3J0IHsgZ2V0QXJyYXlCdWZmZXJGcm9tQmxvYnMgfSBmcm9tICdAL3V0aWxzJwppbXBvcnQgU3BhcmtNRDUgZnJvbSAnc3BhcmstbWQ1JwoKY29uc3QgY2h1bmtzOiBCbG9iW10gPSBbXQoKc2VsZi5vbm1lc3NhZ2UgPSBhc3luYyAoZSkgPT4gewoJY29uc3QgeyBjaHVuaywgY2h1bmtUb3RhbCB9ID0gZS5kYXRhCgljaHVua3MucHVzaChjaHVuaykKCglpZiAoY2h1bmtzLmxlbmd0aCA9PT0gY2h1bmtUb3RhbCkgewoJCWNvbnNvbGUudGltZSgnV29ya2VyIOiuoeeul+aWh+S7tkhhc2jogJfml7bvvJonKQoJCWNvbnN0IGFycmF5QnVmZmVyID0gYXdhaXQgZ2V0QXJyYXlCdWZmZXJGcm9tQmxvYnMoY2h1bmtzKQoJCS8vIEB0cy1pZ25vcmUKCQljb25zdCBoYXNoID0gU3BhcmtNRDUuQXJyYXlCdWZmZXIuaGFzaChhcnJheUJ1ZmZlcikKCQljb25zb2xlLnRpbWVFbmQoJ1dvcmtlciDorqHnrpfmlofku7ZIYXNo6ICX5pe277yaJykKCgkJc2VsZi5wb3N0TWVzc2FnZSh7IGhhc2ggfSkKCQlzZWxmLmNsb3NlKCkKCX0KfQoKc2VsZi5vbmVycm9yID0gKGUpID0+IHsKCWNvbnNvbGUubG9nKGUpCn0K",import.meta.url),u=new Worker(a,{type:"module"}),i=1024*1024*30,p=A(s,i);p.forEach((c,k)=>{u.postMessage({chunk:c,index:k,chunkTotal:p.length})}),u.onmessage=c=>{t({...c.data,chunks:p,chunkSize:i,file:s})},u.onerror=c=>{e(c)}})}async function f(s){const t=s.fileList[0].file,e=1024*1024*30;if(t.size>e){const a=await d(t);r(a)}else m(t)}return(s,t)=>{const e=x,a=z,u=Y,i=X,p=K,c=Q,k=S;return v(),U(k,null,{default:h(()=>[g(c,{title:"大文件切片上传"},{default:h(()=>[g(i,{accept:"*",multiple:"","directory-dnd":"",max:5,"default-upload":!1,onChange:f},{default:h(()=>[g(u,null,{default:h(()=>[G("div",E,[g(e,{size:"48",depth:3},{default:h(()=>[g(w(W))]),_:1})]),g(a,null,{default:h(()=>t[0]||(t[0]=[P(" 点击或者拖动文件到该区域来上传 ")])),_:1})]),_:1})]),_:1}),w(o)>0?(v(),U(p,{key:0,type:"line",percentage:w(o),"indicator-placement":"inside"},null,8,["percentage"])):D("",!0)]),_:1})]),_:1})}}});export{tn as default};
