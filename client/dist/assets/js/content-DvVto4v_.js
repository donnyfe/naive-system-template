import{u as Z,l as G,b as ee}from"./index-DqO_OEbo.js";import{r as j,n as H,k as W,W as O,X as k,Y as p,c as P,w as te,R as F,o as oe,U as v,_,Q as f,$ as V,F as D,a4 as U,O as ne,Z as J,a3 as ae,j as re}from"./vue-vendor-Zc8KthId.js";import{u as se}from"./chat-DfSn68VW.js";import le from"./message-DC6YqHPq.js";import{B as ie,N as ce,R as de,m as ue,T as pe}from"./ui-vendor-D13i6_Ys.js";import{C as fe}from"./ChatbubblesOutline-DW6Z8fY4.js";import"./utils-vendor-lGwZSMVs.js";import"./avatar.vue_vue_type_script_setup_true_lang-TLNQv2B_.js";import"./text.vue_vue_type_style_index_0_lang-6eBzAczY.js";import"./markdown-vendor-CzFv58Rk.js";function he(){const n=j(null);return{scrollRef:n,scrollToBottom:async()=>{await H(),n.value&&(n.value.scrollTop=n.value.scrollHeight)},scrollToTop:async()=>{await H(),n.value&&(n.value.scrollTop=0)},scrollToBottomIfAtBottom:async()=>{if(await H(),n.value){const{scrollHeight:g,scrollTop:s,clientHeight:o}=n.value;g-s-o<=100&&(n.value.scrollTop=g)}}}}const me={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 512 512"},ve=W({name:"PaperPlaneOutline",render:function(a,t){return k(),O("svg",me,t[0]||(t[0]=[p("path",{d:"M53.12 199.94l400-151.39a8 8 0 0 1 10.33 10.33l-151.39 400a8 8 0 0 1-15-.34l-67.4-166.09a16 16 0 0 0-10.11-10.11L53.46 215a8 8 0 0 1-.34-15.06z",fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"32"},null,-1),p("path",{fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"32",d:"M460 52L227 285"},null,-1)]))}}),ge={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 512 512"},we=W({name:"StopCircleOutline",render:function(a,t){return k(),O("svg",ge,t[0]||(t[0]=[p("path",{d:"M448 256c0-106-86-192-192-192S64 150 64 256s86 192 192 192s192-86 192-192z",fill:"none",stroke:"currentColor","stroke-miterlimit":"10","stroke-width":"32"},null,-1),p("path",{d:"M310.4 336H201.6a25.62 25.62 0 0 1-25.6-25.6V201.6a25.62 25.62 0 0 1 25.6-25.6h108.8a25.62 25.62 0 0 1 25.6 25.6v108.8a25.62 25.62 0 0 1-25.6 25.6z",fill:"currentColor"},null,-1)]))}});async function ye(n,a){const t=n.getReader();let r;for(;!(r=await t.read()).done;)a(r.value)}function be(n){let a,t,r,i=!1;return function(s){a===void 0?(a=s,t=0,r=-1):a=ke(a,s);const o=a.length;let d=0;for(;t<o;){i&&(a[t]===10&&(d=++t),i=!1);let c=-1;for(;t<o&&c===-1;++t)switch(a[t]){case 58:r===-1&&(r=t-d);break;case 13:i=!0;case 10:c=t;break}if(c===-1)break;n(a.subarray(d,c),r),d=t,r=-1}d===o?a=void 0:d!==0&&(a=a.subarray(d),t-=d)}}function _e(n,a,t){let r=K();const i=new TextDecoder;return function(s,o){if(s.length===0)t?.(r),r=K();else if(o>0){const d=i.decode(s.subarray(0,o)),c=o+(s[o+1]===32?2:1),w=i.decode(s.subarray(c));switch(d){case"data":r.data=r.data?r.data+`
`+w:w;break;case"event":r.event=w;break;case"id":n(r.id=w);break;case"retry":const x=parseInt(w,10);isNaN(x)||a(r.retry=x);break}}}}function ke(n,a){const t=new Uint8Array(n.length+a.length);return t.set(n),t.set(a,n.length),t}function K(){return{data:"",event:"",id:"",retry:void 0}}var xe=function(n,a){var t={};for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&a.indexOf(r)<0&&(t[r]=n[r]);if(n!=null&&typeof Object.getOwnPropertySymbols=="function")for(var i=0,r=Object.getOwnPropertySymbols(n);i<r.length;i++)a.indexOf(r[i])<0&&Object.prototype.propertyIsEnumerable.call(n,r[i])&&(t[r[i]]=n[r[i]]);return t};const $="text/event-stream",Ie=1e3,q="last-event-id";function Te(n,a){var{signal:t,headers:r,onopen:i,onmessage:g,onclose:s,onerror:o,openWhenHidden:d,fetch:c}=a,w=xe(a,["signal","headers","onopen","onmessage","onclose","onerror","openWhenHidden","fetch"]);return new Promise((x,M)=>{const I=Object.assign({},r);I.accept||(I.accept=$);let u;function B(){u.abort(),document.hidden||E()}d||document.addEventListener("visibilitychange",B);let N=Ie,T=0;function C(){document.removeEventListener("visibilitychange",B),window.clearTimeout(T),u.abort()}t?.addEventListener("abort",()=>{C(),x()});const z=c??window.fetch,A=i??Ce;async function E(){var R;u=new AbortController;try{const e=await z(n,Object.assign(Object.assign({},w),{headers:I,signal:u.signal}));await A(e),await ye(e.body,be(_e(l=>{l?I[q]=l:delete I[q]},l=>{N=l},g))),s?.(),C(),x()}catch(e){if(!u.signal.aborted)try{const l=(R=o?.(e))!==null&&R!==void 0?R:N;window.clearTimeout(T),T=window.setTimeout(E,l)}catch(l){C(),M(l)}}}E()})}function Ce(n){const a=n.headers.get("content-type");if(!a?.startsWith($))throw new Error(`Expected content-type to be ${$}, Actual: ${a}`)}const Se={class:"h-full flex flex-1 flex-col overflow-hidden bg-light dark:bg-dark transition-colors duration-300"},Oe={class:"flex items-center justify-between px-6 py-2.5 backdrop-blur border-gray-200 dark:border-gray-800"},Be={class:"flex gap-3"},Ee={class:"flex-1 min-h-0"},Re={key:0,class:"flex flex-col justify-center h-full items-center space-y-4"},je={class:"text-4xl font-bold text-gray-800 dark:text-gray-200"},Me={class:"text-base text-gray-500 dark:text-gray-400"},Ne={class:"py-4 px-4 bg-white/80 dark:bg-dark/80 backdrop-blur shadow-md border-gray-200 dark:border-gray-800"},Le={class:"max-w-4xl mx-auto"},Pe={class:"flex flex-wrap gap-2 mb-2"},$e={class:"flex gap-2"},ze=W({__name:"content",setup(n){const{t:a}=Z(),{scrollRef:t,scrollToBottom:r,scrollToBottomIfAtBottom:i}=he(),g=j(null),s=j(!1),o=se();function d(){o.showSidebar=!o.showSidebar}const c=P(()=>o.prompt),w=P(()=>o.promptList),x=P(()=>c.value.startsWith("/")?w.value.length===0?($message.warning("暂无指令, 请点击指令中心新建指令"),[]):w.value.filter(e=>e.content.toLowerCase().includes(c.value.substring(1).toLowerCase())).map(e=>({label:e.content,value:e.content})):[]),M=P(()=>o.chat),I=j(o.activeId),u=j({chatId:"",previousId:"",messageId:"",messageText:"",sender:"",completed:0});te(()=>o.chat,e=>{if(e){const l=F(e);I.value=l.chatId;const y=l.messages?.filter(b=>b.sender==="assistant").pop();y&&(u.value=y)}else o.chat=null}),oe(async()=>{r(),g.value&&g.value?.focus()});async function B(){if(s.value)return;const e=c.value.trim();if(!e)return;o.activeId||await o.createChat({chatName:e.slice(0,30)});const y=await o.createMessage({chatId:o.activeId,messageText:e,sender:"user",completed:1});try{u.value=await o.createMessage({chatId:o.activeId,previousId:y?.messageId,messageText:"",sender:"assistant",completed:0})}catch(b){console.error(b)}r(),T(u.value)}const N=new Set;async function T(e){o.prompt="",s.value=!0;const l=o.activeId;if(!l)return console.error("缺少对话");const y={chatId:l,previousId:e.previousId},b=new AbortController;await Te("/api/chat/submit",{method:"POST",headers:{"Content-Type":"application/json","Cache-Control":"no-cache",Connection:"keep-alive",Authorization:`Bearer ${G.get("accessToken")||""}`},body:JSON.stringify(y),signal:b.signal,async onopen(h){h.ok&&h.headers.get("Content-type").includes($)},async onmessage(h){if(h.event==="error"){console.error(h);return}if(e.completed!==1&&h.data)try{let S=JSON.parse(h.data);e.messageText+=S.result,i(),S.is_end&&(e.completed=1,s.value=!1,await C(F(e)))}catch(S){console.error("Error parsing message:",S)}},onclose(){console.log("SSE connection closed"),s.value=!1,N.clear()},onerror(h){s.value=!1,console.error("Stream error:",h)}})}async function C(e){const l={chatId:e.chatId,previousId:e.previousId,messageId:e.messageId,messageText:e.messageText,sender:e.sender,completed:1};await o.updateMessage(l)}function z(e){e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),B())}async function A(e){e.messageText="",e.completed=0,s.value=!0,T(e)}async function E(){s.value&&(u.value.chatId&&(u.value.messageText=a("chat.chatStop"),u.value.completed=1,await C(F(u.value))),s.value=!1)}function R(e){switch(console.log(e),e){case"指令中心":o.showPromptSidebar=!o.showPromptSidebar;break}}return(e,l)=>{const y=ce,b=ie,h=pe,S=ue,Q=de;return k(),O("div",Se,[p("div",Oe,[p("div",Be,[v(b,{class:"w-10 h-10 rounded-xl bg-white dark:bg-dark hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors",onClick:d},{icon:_(()=>[v(y,null,{default:_(()=>[v(f(fe))]),_:1})]),_:1})])]),p("div",Ee,[p("div",{id:"scrollRef",ref_key:"scrollRef",ref:t,class:"h-full overflow-x-hidden overflow-y-auto px-4"},[f(M)?.messages?.length?(k(!0),O(D,{key:1},U(f(M)?.messages,(m,L)=>(k(),J(le,{key:L,item:m.messageId===f(u)?.messageId?f(u):m,loading:m.completed===0,onRegenerate:A},null,8,["item","loading"]))),128)):(k(),O("div",Re,[p("div",je,V(e.$t("chat.title")),1),p("div",Me,V(e.$t("chat.intro")),1)]))],512)]),p("div",Ne,[p("div",Le,[p("div",Pe,[(k(),O(D,null,U(["指令中心"],m=>v(h,{key:m,bordered:!0,type:"primary",size:"small",round:"",class:"cursor-pointer hover:bg-primary hover:text-white transition-colors",onClick:L=>R(m)},{default:_(()=>[re(V(m),1)]),_:2},1032,["onClick"])),64))]),v(Q,{value:f(o).prompt,"onUpdate:value":l[1]||(l[1]=m=>f(o).prompt=m),class:"w-full",options:f(x)},{default:_(({handleInput:m,handleBlur:L,handleFocus:X})=>[v(S,{ref_key:"inputRef",ref:g,value:f(c),"onUpdate:value":l[0]||(l[0]=Y=>ne(c)?c.value=Y:null),type:"textarea",rows:"1",autosize:"",class:"rounded-xl shadow-sm hover:shadow-md focus:shadow-lg transition-shadow",placeholder:e.$t("chat.chatPlaceholder"),onInput:m,onFocus:X,onBlur:L,onKeypress:z},{suffix:_(()=>[p("div",$e,[v(b,{bordered:!1,loading:f(s),class:"w-10 h-10 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors",onClick:B},{icon:_(()=>[v(y,{size:"18"},{default:_(()=>[v(f(ve))]),_:1})]),_:1},8,["loading"]),f(s)?(k(),J(b,{key:0,bordered:!1,class:"w-10 h-10 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors",onClick:E},{icon:_(()=>[v(y,{size:"20"},{default:_(()=>[v(f(we))]),_:1})]),_:1})):ae("",!0)])]),_:2},1032,["value","placeholder","onInput","onFocus","onBlur"])]),_:1},8,["value","options"])])])])}}}),Qe=ee(ze,[["__scopeId","data-v-e1bd94e0"]]);export{Qe as default};
